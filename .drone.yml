---
kind: pipeline
name: build
type: docker

steps:
- name: build hugo website
  image: peaceiris/hugo
  commands:
  - hugo
  - tar -cvf ${DRONE_BRANCH}.podcast.menschen.software.tar public/
  when:
    branch:
    - main
    - dev

- name: upload to blob
  image: plugins/s3
  settings:
    endpoint: https://blob.pfudi.de/
    bucket: drone
    access_key: 
      from_secret: blob_access_key
    secret_key: 
      from_secret: blob_secret_key
    source: ${DRONE_BRANCH}.podcast.menschen.software.tar
    target: /
    path_style: true
  when:
    branch:
    - main
    - dev


# Copy the files to a docker volume mounted locally
- name: deploy to mounted volume - prod
  image: eeacms/rsync
  volumes:
  - name: prod_directory
    path: /srv/public
  commands:
    - rsync -azv --delete public/ /srv/public/
  when:
    branch:
    - main

- name: deploy to mounted volume - dev
  image: eeacms/rsync
  volumes:
  - name: test_directory
    path: /srv/public
  commands:
    - pwd
    - ls -lah .
    - ls -lah /srv/
    - ls -lah /srv/public/
    - rsync -azv --delete public/ /srv/public/
  when:
    branch:
    - dev

volumes:
- name: test_directory
  host:
    path: /usr/share/nginx/html/test.podcast.menschen.software/
- name: prod_directory
  host:
    path: /usr/share/nginx/html/podcast.menschen.software/